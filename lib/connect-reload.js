// Generated by CoffeeScript 1.3.3
(function() {
  var client, debounce, hound, path, socketio, util;

  hound = require('hound');

  path = require('path');

  socketio = require('socket.io');

  util = require('util');

  debounce = function(fn, timeout) {
    return function() {
      clearTimeout(timeout);
      return timeout = setTimeout(fn, 20);
    };
  };

  client = function() {
    var reload, script, server, target;
    server = '//%s:%s/';
    reload = function() {
      return io.connect(server).on('connect-reload', function() {
        return document.location.reload(true);
      });
    };
    if (typeof io !== "undefined" && io !== null) {
      return reload();
    }
    script = document.createElement('script');
    script.src = server + 'socket.io/socket.io.js';
    script.onload = reload;
    target = document.getElementsByTagName('script')[0];
    return target.parentNode.insertBefore(script, target.nextSibling);
  };

  client = "(" + client + "());";

  module.exports = function(_arg) {
    var address, dir, dog, emit, io, port, reload, server;
    address = _arg.address, dir = _arg.dir, port = _arg.port, server = _arg.server;
    dog = hound.watch(dir);
    io = socketio.listen(server, {
      'log level': 0
    });
    emit = debounce(function() {
      return io.sockets.emit('connect-reload');
    });
    reload = function(file) {
      if (path.basename(file).indexOf('.')) {
        return emit();
      }
    };
    dog.on('create', reload);
    dog.on('change', reload);
    dog.on('error', function() {});
    return function(_arg1, res, next) {
      var url;
      url = _arg1.url;
      if (url.slice(-17) !== 'connect-reload.js') {
        return next();
      }
      res.setHeader('Content-Type', 'text/javascript');
      return res.end(util.format(client, address, port));
    };
  };

}).call(this);
